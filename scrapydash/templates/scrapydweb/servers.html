{% extends "base_modern.html" %}

{% block title %}Servers{% endblock %}

{% block extra_head %}
<style>
    .server-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .server-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: all 0.3s ease;
        border-left: 4px solid var(--success-color);
    }

    .server-card.offline {
        border-left-color: var(--danger-color);
    }

    .server-card.warning {
        border-left-color: var(--warning-color);
    }

    .server-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    .server-header {
        padding: 1.5rem;
        background: var(--light-color);
        border-bottom: 1px solid #e2e8f0;
    }

    .server-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: var(--dark-color);
    }

    .server-url {
        color: var(--secondary-color);
        font-size: 0.9rem;
        word-break: break-all;
    }

    .server-body {
        padding: 1.5rem;
    }

    .server-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--secondary-color);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .server-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .action-btn {
        flex: 1;
        min-width: 120px;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        text-align: center;
        transition: all 0.2s ease;
    }

    .action-btn:hover {
        transform: translateY(-1px);
    }

    .btn-primary-action {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary-action:hover {
        background: #1d4ed8;
        color: white;
    }

    .btn-secondary-action {
        background: #f1f5f9;
        color: var(--secondary-color);
        border: 1px solid #e2e8f0;
    }

    .btn-secondary-action:hover {
        background: #e2e8f0;
        color: var(--dark-color);
    }

    .add-server-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .add-server-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    .add-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.8;
    }

    .connection-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .connection-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success-color);
        animation: pulse 2s infinite;
    }

    .connection-dot.offline {
        background: var(--danger-color);
        animation: none;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .server-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .info-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .info-label {
        font-size: 0.75rem;
        color: var(--secondary-color);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .info-value {
        font-weight: 600;
        color: var(--dark-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-gradient mb-0">Servers</h1>
                <p class="text-muted">Manage and monitor your Scrapyd servers</p>
            </div>
            <button class="btn btn-primary-modern" data-bs-toggle="modal" data-bs-target="#addServerModal">
                <i class="fas fa-plus me-2"></i>Add Server
            </button>
        </div>
    </div>
</div>

<!-- Server Grid -->
<div class="server-grid">
    {% for server in SCRAPYD_SERVERS %}
    <div class="server-card">
        <div class="server-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="server-title">[{{ loop.index }}] Server {{ loop.index }}</div>
                    <div class="server-url">{{ server }}</div>
                </div>
                <div class="connection-indicator">
                    <div class="connection-dot"></div>
                    <span>Online</span>
                </div>
            </div>
        </div>
        
        <div class="server-body">
            <div class="server-stats">
                <div class="stat-item">
                    <div class="stat-value">3</div>
                    <div class="stat-label">Projects</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">12</div>
                    <div class="stat-label">Spiders</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">2</div>
                    <div class="stat-label">Running</div>
                </div>
            </div>
            
            <div class="server-actions">
                <a href="/{{ loop.index }}/jobs/" class="action-btn btn-primary-action">
                    <i class="fas fa-tasks me-1"></i>Jobs
                </a>
                <a href="/{{ loop.index }}/schedule/" class="action-btn btn-secondary-action">
                    <i class="fas fa-rocket me-1"></i>Schedule
                </a>
                <a href="/{{ loop.index }}/deploy/" class="action-btn btn-secondary-action">
                    <i class="fas fa-upload me-1"></i>Deploy
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Add Server Card -->
    <div class="server-card add-server-card" data-bs-toggle="modal" data-bs-target="#addServerModal">
        <div class="add-icon">
            <i class="fas fa-plus-circle"></i>
        </div>
        <h5 class="mb-2">Add New Server</h5>
        <p class="mb-0 opacity-75">Configure a new Scrapyd server</p>
    </div>
</div>

<!-- Server Information -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card-modern">
            <div class="card-header-modern">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Server Information
                </h5>
            </div>
            <div class="card-body">
                <div class="server-info-grid">
                    <div class="info-card">
                        <div class="info-label">Total Servers</div>
                        <div class="info-value">{{ SCRAPYD_SERVERS_AMOUNT }}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Online Servers</div>
                        <div class="info-value">{{ SCRAPYD_SERVERS_AMOUNT }}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Total Projects</div>
                        <div class="info-value">8</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Active Jobs</div>
                        <div class="info-value">5</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Server Modal -->
<div class="modal fade" id="addServerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Server</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="serverUrl" class="form-label">Server URL</label>
                        <input type="url" class="form-control" id="serverUrl" placeholder="http://localhost:6800">
                        <div class="form-text">Enter the full URL of your Scrapyd server</div>
                    </div>
                    <div class="mb-3">
                        <label for="serverName" class="form-label">Server Name (Optional)</label>
                        <input type="text" class="form-control" id="serverName" placeholder="Production Server">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="testConnection">
                        <label class="form-check-label" for="testConnection">
                            Test connection before adding
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Add Server</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Simulate server status checks
    function updateServerStatus() {
        document.querySelectorAll('.server-card:not(.add-server-card)').forEach((card, index) => {
            const dot = card.querySelector('.connection-dot');
            const status = card.querySelector('.connection-indicator span');
            
            // Simulate occasional offline status
            if (Math.random() > 0.9) {
                dot.classList.add('offline');
                status.textContent = 'Offline';
                card.classList.add('offline');
            } else {
                dot.classList.remove('offline');
                status.textContent = 'Online';
                card.classList.remove('offline');
            }
        });
    }
    
    // Update server status every 30 seconds
    setInterval(updateServerStatus, 30000);
    
    // Add server form handling
    document.querySelector('#addServerModal .btn-primary').addEventListener('click', function() {
        const url = document.getElementById('serverUrl').value;
        const name = document.getElementById('serverName').value;
        const testConnection = document.getElementById('testConnection').checked;
        
        if (!url) {
            alert('Please enter a server URL');
            return;
        }
        
        // Here you would normally send the data to the server
        console.log('Adding server:', { url, name, testConnection });
        
        // Close modal and show success message
        const modal = bootstrap.Modal.getInstance(document.getElementById('addServerModal'));
        modal.hide();
        
        // Reset form
        document.getElementById('serverUrl').value = '';
        document.getElementById('serverName').value = '';
        document.getElementById('testConnection').checked = false;
    });
</script>
{% endblock %}
